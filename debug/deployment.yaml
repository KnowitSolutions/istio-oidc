apiVersion: v1
kind: Namespace
metadata:
  name: istio-oidc
  labels:
    istio-injection: enabled
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: istio-oidc
subjects:
- kind: ServiceAccount
  namespace: istio-oidc
  name: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: istio-oidc
---
apiVersion: v1
kind: Service
metadata:
  namespace: istio-oidc
  name: istio-oidc
spec:
  clusterIP: None
  selector:
    app: istio-oidc
  ports:
  - name: grpc
    port: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: istio-oidc
  name: istio-oidc
spec:
  selector:
    matchLabels:
      app: istio-oidc
  template:
    metadata:
      labels:
        app: istio-oidc
    spec:
      containers:
      - name: istio-oidc
        image: # TODO: Set debug image
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: config
          mountPath: /app/config.yaml
          subPath: config.yaml
      volumes:
      - name: config
        configMap:
          name: istio-oidc
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: istio-oidc
  name: istio-oidc
data:
  config.yaml: |
    ExtAuthz:
      ClusterName: istio-oidc.istio-oidc
      Timeout: 1h
    Keycloak:
      URL: # TODO: Set Keycloak URL